# Requirements Document

## Introduction

The OpenTelemetry (OTEL) traces integration with Mezmo pipelines has previously been functional but is currently broken. This feature is critical for enabling distributed tracing in sales demonstrations, allowing the sales team to showcase Mezmo's comprehensive observability capabilities including logs, metrics, and traces. The restoration and enhancement of trace collection ensures that the application can demonstrate real-time request flow visualization and performance monitoring capabilities to potential customers.

## Alignment with Product Vision

This feature directly supports the product vision outlined in product.md by:

- **Demonstration Focused**: Enables sales teams to showcase complete observability with traces alongside logs and metrics
- **Multi-Agent Support**: Strengthens the OTEL Collector integration as one of the primary supported agents
- **Reliability & Performance**: Ensures consistent trace generation and collection during critical client demonstrations
- **Simplicity First**: Maintains the existing one-click configuration while fixing the broken trace pipeline
- **Professional Appearance**: Provides visual proof of distributed tracing capabilities suitable for enterprise clients

## Requirements

### Requirement 1: Restore OTEL Traces to Mezmo Pipeline

**User Story:** As a sales engineer, I want OTEL traces to be successfully sent to the Mezmo pipeline, so that I can demonstrate distributed tracing capabilities during client presentations

#### Acceptance Criteria

1. WHEN the OTEL collector is configured with trace pipeline credentials THEN the system SHALL successfully export traces to https://pipeline.use.dev.logdna.net/v1/5c7e0854-7705-11f0-b8ef-0260f52d7685
2. IF traces are generated by the frontend application THEN the backend proxy SHALL forward them to the OTEL collector without modification
3. WHEN traces are sent to the Mezmo pipeline THEN the Authorization header SHALL include the correct access key (PCptnL3ukYQec5SEDGoC+zaU643ugfQHIGM6/YhGNfs=)
4. IF the OTEL collector receives traces THEN it SHALL export them using the otlphttp exporter with application/x-protobuf content-type
5. WHEN the trace pipeline is enabled in configuration THEN the collector SHALL NOT interfere with existing logs and metrics pipelines

### Requirement 2: Maintain Backward Compatibility

**User Story:** As a sales engineer, I want the trace fix to not break existing log and metric collection, so that I can continue demonstrating all observability signals reliably

#### Acceptance Criteria

1. WHEN OTEL traces are fixed THEN the Mezmo Agent SHALL continue to function normally for log collection
2. IF the OTEL collector is restarted with trace configuration THEN existing log pipelines SHALL remain operational
3. WHEN traces are enabled THEN metric collection via hostmetrics receiver SHALL continue without interruption
4. IF trace export fails THEN the system SHALL NOT cascade failures to other pipelines

### Requirement 3: Frontend-to-Backend Trace Proxy

**User Story:** As a developer, I want the frontend to send traces through the backend proxy, so that we avoid CORS issues and maintain security

#### Acceptance Criteria

1. WHEN the frontend generates traces THEN it SHALL send them to /api/traces/v1/traces on the backend
2. IF the backend receives trace data at /api/traces/v1/traces THEN it SHALL forward to http://localhost:4318/v1/traces
3. WHEN the OTEL collector is not running THEN the proxy SHALL return a 503 Service Unavailable status
4. IF trace forwarding succeeds THEN the backend SHALL return appropriate success responses to the frontend

### Requirement 4: Configuration Management

**User Story:** As a sales engineer, I want trace configuration to be managed through the existing UI, so that I can easily enable/disable traces without manual file editing

#### Acceptance Criteria

1. WHEN traces are configured in agents-config.json THEN the UI SHALL reflect the correct pipeline ID and ingestion key
2. IF the trace ingestion key is updated in the UI THEN the OTEL collector configuration SHALL be regenerated
3. WHEN the collector configuration is generated THEN it SHALL include the correct Mezmo pipeline endpoint format
4. IF traces are disabled in configuration THEN the collector SHALL exclude the traces pipeline from its service configuration

### Requirement 5: Health Monitoring and Diagnostics

**User Story:** As a sales engineer, I want to verify that traces are working before a demo, so that I can troubleshoot issues proactively

#### Acceptance Criteria

1. WHEN the /api/otel/status endpoint is called THEN it SHALL report the health of the traces pipeline
2. IF traces are being exported successfully THEN the status SHALL indicate "traces: enabled" with no errors
3. WHEN trace export fails THEN detailed error messages SHALL be logged for troubleshooting
4. IF the collector encounters trace export errors THEN they SHALL be visible in /tmp/codeuser/otel-traces-debug.json

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: Trace handling code should be separate from log and metric handling
- **Modular Design**: Trace configuration should be managed through the existing ConfigManager service
- **Dependency Management**: Trace functionality should not create new dependencies on external services
- **Clear Interfaces**: The trace proxy endpoint should maintain a clear contract with the frontend

### Performance
- Trace export batch size SHALL be optimized (1024 traces per batch) to prevent memory issues
- The backend proxy SHALL add minimal latency (<10ms) to trace forwarding
- Trace buffering SHALL prevent data loss during temporary network interruptions
- The system SHALL handle up to 1000 traces per second during stress testing

### Security
- Ingestion keys SHALL be stored securely and never exposed in client-side code
- The backend proxy SHALL validate trace payloads before forwarding
- CORS headers SHALL be properly configured to allow only authorized origins
- Sensitive trace attributes SHALL be sanitized before export

### Reliability
- The system SHALL gracefully handle OTEL collector restarts without losing traces
- Trace export failures SHALL NOT cause application crashes or memory leaks
- The proxy SHALL implement retry logic with exponential backoff for transient failures
- Health checks SHALL accurately report trace pipeline availability

### Usability
- Trace configuration SHALL be accessible through the existing Agents Configuration UI
- Error messages SHALL provide actionable guidance for troubleshooting
- The system SHALL provide visual feedback when traces are being collected successfully
- Configuration changes SHALL take effect without requiring application restart